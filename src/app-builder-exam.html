<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<dom-module id="app-builder-exam">
  <template>
    <style>
       :host {
        display: block;
        padding: 10px;
        font-family: 'Roboto', 'Times New Roman', Times, serif;
      }

      .card {
        margin: 24px;
        padding: 16px;
        color: #757575;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .circle {
        display: inline-block;
        width: 64px;
        height: 64px;
        text-align: center;
        color: #555;
        border-radius: 50%;
        background: #ddd;
        font-size: 30px;
        line-height: 64px;
      }

      paper-checkbox {
        display: block;
        margin-top: 5px;
      }

      .question {
        color: black;
        font-size: 20px;

        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        text-align: justify;
      }

      p {
        word-wrap: break-word;
        color: black;
      }

      pre p {
        margin: 0;
      }

      .pagination {
        margin-top: 20px;
      }

      .wrong {
        background-color: red;
      }

      .right {
        background-color: green;
      }

      .ind {
        background-color: gray;
      }

      .answer {
        margin-top: 10px;
      }

      app-header {
        @apply --layout-fixed-top;
        color: #fff;
        --app-header-background-rear-layer: {
          background-color: #ef6c00;
        }
        ;
      }

      paper-progress {
        display: block;
        width: 100%;
        --paper-progress-active-color: rgba(255, 255, 255, 0.5);
        --paper-progress-container-color: transparent;
      }

      app-toolbar {
        background-color: #4285f4;
        color: #fff;
      }

      .submitted {
        padding-top: 64px;
      }

      a {
        text-decoration: none;
        color: black;
      }

      paper-radio-button {
        display: block;
      }

      .choose {
        font-size: 17px;
      }

      .ca {
        font-size: 17px;
        display: block;
        color: black;
      }

      .ca .title {
        margin-top: 10px;
      }
    </style>

    <iron-ajax auto url="question.json" handle-as="json" on-response="handleResponse"></iron-ajax>

    <div class="card submitted" hidden$="[[isSubmited]]">
      <app-header fixed>
        <app-toolbar>
          <div main-title>Time: [[timer]]</div>
          <paper-icon-button icon="refresh" onclick="location.reload();"></paper-icon-button>
          <paper-progress value="10" indeterminate bottom-item hidden$="[[!progress]]"></paper-progress>
        </app-toolbar>
      </app-header>
      <div class="circle">[[currentQuestion.id]]</div>
      <h3>Question</h3>
      <span class="question">[[currentQuestion.question]]</span>
      <template is="dom-if" if="[[currentQuestion.choose]]">
        <br>
        <span class="question choose">[[currentQuestion.choose]]</span>
      </template>



      <div class="answer">

        <template is="dom-if" if="[[currentQuestion.isRadioButton]]">
          <paper-radio-group allow-empty-selection>
            <template is="dom-repeat" items="[[currentQuestion.answers]]" as="a">
              <paper-radio-button name="[[a.ca]]" on-keydown="onRadioKeyDown" checked="{{a.checked}}">[[a.answer]]</paper-radio-button>
            </template>
          </paper-radio-group>
        </template>

        <template is="dom-if" if="[[!currentQuestion.isRadioButton]]">
          <template is="dom-repeat" items="[[currentQuestion.answers]]">
            <div style="text-align: justify; padding: 10px 10px 10px 0;">
              <paper-checkbox name="[[item.answer]]" checked="{{item.checked}}">[[item.answer]]</paper-checkbox>
            </div>
          </template>
        </template>


      </div>
      <div class="pagination">

        <paper-icon-button icon="icons:arrow-back" disabled$="[[canBack]]" on-click="back"></paper-icon-button>
        <paper-icon-button icon="icons:arrow-forward" disabled$="[[canNext]]" on-click="next"></paper-icon-button>
        <span>[[_addOneValue(currentQuestionIndex)]] of [[totalQuestions]]</span>
        <br>
        <paper-button raised on-click="submit">Submit</paper-button>

      </div>
    </div>

    <div hidden$="[[!isSubmited]]">
      <app-header fixed>
        <app-toolbar>
          <div main-title>Percentage: [[rightPercentage]] Time: [[timer]]</div>
          <paper-icon-button icon="refresh" onclick="location.reload();"></paper-icon-button>
          <paper-progress id="submited" value="10" indeterminate bottom-item hidden$="[[!progress]]"></paper-progress>
        </app-toolbar>
      </app-header>
      <div class="submitted">

        <template is='dom-repeat' items="{{questionsSubmited}}" as="questionObj">
          <div class="card">

            <div class$="[[questionObj.ball]]">[[questionObj.id]]</div>
            <h3>Question</h3>
            <span class="question">[[questionObj.question]]</span>
            <template is="dom-if" if="[[currentQuestion.choose]]">
              <span class="question choose">[[questionObj.choose]]</span>
            </template>

            <div class="answer">

              <template is="dom-if" if="[[questionObj.isRadioButton]]">

                <paper-radio-group allow-empty-selection>
                  <template is="dom-repeat" items="[[questionObj.answers]]" as="a">
                    <paper-radio-button name="[[a.ca]]" checked="[[a.checked]]" disabled>[[a.answer]]</paper-radio-button>
                  </template>
                </paper-radio-group>

              </template>

              <template is="dom-if" if="[[!questionObj.isRadioButton]]">

                <template is="dom-repeat" items="[[questionObj.answers]]" as="a">
                  <div style="text-align: justify; padding: 10px 10px 10px 0;">
                    <paper-checkbox name="[[a.answer]]" checked$="[[a.checked]]" disabled="true">[[a.answer]]</paper-checkbox>
                  </div>
                </template>
              </template>
              <span class="ca title">
                Correct Answer
              </span>
              <template is="dom-repeat" items="[[questionObj.answer]]" as="ca">
                <span class="ca">[[ca]]<span>
              </template>



              <template is='dom-if' if="[[questionObj.moreInformationLinks]]">
                <h2>More information At:</h2>
                <template is="dom-repeat" items="[[questionObj.moreInformationLinks]]" as="link">
                  <a href="[[link.link]]" target="_blank">
                    <paper-button raised>[[link.label]]</paper-button>
                  </a>
                </template>
              </template>

            </div>
          </div>
        </template>
      </div>

    </div>

  </template>

  <script>
    (function () {
      "use strict";

      const WRONG = 'wrong',
        RIGHT = 'right',
        NUMBER_OF_QUESTIONS = parseInt(prompt('Please, insert the number(1 - 110) of questions?', '40')) || 40;
      let xDown = null,
        yDown = null;
      Polymer({
        is: 'app-builder-exam',

        properties: {
          questions: {
            type: Array,
            notify: true
          },
          timer: String,
          timerInterval: Number,
          rightPercentage: String,
          questionsSubmited: {
            type: Array,
            notify: true
          },
          progress: {
            type:Boolean,
            value: true
          },
          currentQuestion: Object,
          currentQuestionIndex: Number,
          totalQuestions: Number,
          canNext: Boolean,
          canBack: Boolean,
          isSubmited: Boolean
        },

        arrows: function (e) {
          e.stopPropagation();
          switch (e.which) {
            case 37: // left
              this.back();
              break;
            case 39: // right
              this.next();
              break;
            default:
              return; // exit this handler for other keys
          }
        },

        onRadioKeyDown: function(e) {
          if ([37, 39].indexOf(e.which) !== -1) {
            e.stopPropagation();
            return false;
          }
        },

        handleResponse: function (e) {
          this._handleTimer.bind(this)();
          this._initializeEvent.bind(this)();
          this.isSubmited = false;
          this.currentQuestionIndex = 0;
          // suffle and slice questions
          this.questions = this._prepareQuestions.bind(this)(e.detail.response);
          this.canBack = true;
          this.totalQuestions = this.questions.length;
          this.currentQuestion = this.questions[0];
          this.canNext = this.questions.length < 1;
          this.progress = false;
        },

        next: function () {
          if ((this.currentQuestionIndex + 1) !== this.questions.length) {
            this.currentQuestionIndex++;
            this.currentQuestion = this.questions[this.currentQuestionIndex];
            this.canNext = (this.currentQuestionIndex + 1) === this.questions.length;
            this.canBack = this.currentQuestionIndex < 1;
          }
        },

        back: function () {
          if (this.currentQuestionIndex > 0) {
            this.currentQuestionIndex--;
            this.currentQuestion = this.questions[this.currentQuestionIndex];
            this.canBack = this.currentQuestionIndex < 1;
            this.canNext = (this.currentQuestionIndex + 1) === this.questions.length;
          }
        },

        submit: function () {
          this.progress = true;
          clearInterval(this.timerInterval);
          let questionsAux = this.questions.slice(0);
          const _this = this;
          let counter = 0;
          questionsAux = questionsAux.map(obj => {
            obj.ball = 'circle ' + _this._isRightQuestion.bind(_this)(obj);
            obj.isRight && counter++;
            if (!obj.isTrueFalseQuestion) {
              let answer = obj.answer;
              for (let i = 0; i < obj.answers.length; i++) {
                if (obj.answer.indexOf(obj.answers[i].ca) >= 0) {
                  answer = answer.replace(obj.answers[i].ca, ";" + obj.answers[i].answer.slice(0, 2));
                }
              }
              answer = answer.replace(';','').split(';').sort();
              obj.answer = answer;
            } else {
              obj.answer = [obj.answer];
            }
            return obj;
          });
          this.rightPercentage = ((counter / questionsAux.length) * 100).toFixed(2) + "%";
          this.questionsSubmited = questionsAux;
          this.isSubmited = true;
          this.progress = false;
        },

        _shuffle: function (array) {
          var currentIndex = array.length,
            temporaryValue, randomIndex;

          // While there remain elements to shuffle...
          while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }

          return array;
        },

        _prepareQuestions: function (questions) {
          const _this = this;
          questions = _this._shuffle(questions);
          questions = questions.slice(0, NUMBER_OF_QUESTIONS);
          return questions.map(_this._shuffleAnswers.bind(_this))
        },

        _initializeEvent: function () {
          document.addEventListener('touchstart', this._handleTouchStart.bind(this), false);
          document.addEventListener('touchmove', this._handleTouchMove.bind(this), false);
          document.body.addEventListener('keyup', this.arrows.bind(this));
        },

        _isRightQuestion: function (question) {
          if (!question.answers) return WRONG;
          if (question.isRadioButton) {
              var userAnswer = question.answers.filter(a => a.checked);
              if (userAnswer.length < 1) return WRONG;
              userAnswer = userAnswer[0];
            if (question.isTrueFalseQuestion) {
              question.isRight = (question.answer.startsWith('False') && userAnswer.ca === 'False') ||
                (question.answer.startsWith('True') && userAnswer.ca === 'True');

              return question.isRight ? RIGHT : WRONG;
            } else {
              question.isRight = (question.answer.slice(0, 2) === userAnswer.ca);
              return question.isRight ? RIGHT : WRONG;
            }
          } else {
            let spplitedCorrectAnswer = this._splitAnswers(question.answer).map(a => a.slice(0, 2)),
              userAnwers = question.answers.filter(a => a.checked).map(a => a.ca);

            if (spplitedCorrectAnswer.length !== userAnwers.length) {
              question.isRight = false;
              return WRONG;
            }

            for (let i = 0; i < spplitedCorrectAnswer.length; i++)
              if (userAnwers.indexOf(spplitedCorrectAnswer[i]) === -1) {
                question.isRight = false;
                return WRONG;
              }
            question.isRight = true;
            return RIGHT;
          }
        },

        _getLetter: function (i) {
          switch (i) {
            case 0:
              return 'A.';
            case 1:
              return 'B.';
            case 2:
              return 'C.';
            case 3:
              return 'D.';
            case 4:
              return 'E.';
            case 5:
              return 'F.';
          }
        },

        _shuffleAnswers: function (q) {
          if (q.answers) {
            q.answers = (q.answers && !q.isTrueFalseQuestion) ? this._shuffle(q.answers) : q.answers;
            let indexOfAllAbove = -1;
            for (let i = 0; i < q.answers.length; i++) {
              if (q.answers[i].answer === 'All of the above') {
                indexOfAllAbove = i;
                break;
              }
            }
            if (indexOfAllAbove >= 0 && indexOfAllAbove !== (q.answers.length - 1)) {
              let lastA = q.answers[q.answers.length - 1];
              q.answers[q.answers.length - 1] = q.answers[indexOfAllAbove];
              q.answers[indexOfAllAbove] = lastA;
            }

            for (let i = 0; i < q.answers.length; i++) {
              if (q.isTrueFalseQuestion) break;
              q.answers[i].answer = this._getLetter(i) + " " + q.answers[i].answer;
            }
          }
          return q;
        },

        _handleTimer: function () {
          this.timer = '00:00:00';
          let _this = this;
          this.timerInterval = setInterval(() => {
            let splitted = _this.timer.split(':');
            let sec = parseInt(splitted[2]),
              min = parseInt(splitted[1]),
              hour = parseInt(splitted[0]);
            if (sec === 60) {
              sec = 0;
              if (min === 60) {
                min = 0;
                hour++;
              } else {
                min++;
              }
            } else {
              sec++;
            }
            sec = sec < 10 ? '0' + sec : sec + "";
            min = min < 10 ? '0' + min : min + "";
            hour = hour < 10 ? '0' + hour : hour + "";
            _this.timer = hour + ":" + min + ":" + sec;
          }, 1000);

        },

        _addOneValue: function (value) {
          return value + 1;
        },

        _splitAnswers: function (q) {
          const answers = [];
          const qf = q.split('F. '),
            qe = qf[0].split('E. '),
            qd = qe[0].split('D. '),
            qc = qd[0].split('C. '),
            qb = qc[0].split('B. '),
            qa = qb[0].split('A. ');
          qf.length > 1 && answers.push('F. ' + qf[1]);
          qe.length > 1 && answers.push('E. ' + qe[1]);
          qd.length > 1 && answers.push('D. ' + qd[1]);
          qc.length > 1 && answers.push('C. ' + qc[1]);
          qb.length > 1 && answers.push('B. ' + qb[1]);
          qa.length > 1 && answers.push('A. ' + qa[1]);
          answers.reverse();
          return answers;
        },

        _downloadJson: function (jsonObj) {
          var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonObj));
          var dlAnchorElem = document.createElement('a');
          dlAnchorElem.setAttribute("href", dataStr);
          dlAnchorElem.setAttribute("download", "question.json");
          dlAnchorElem.click();
        },

        _handleTouchStart: function (evt) {
          xDown = evt.touches[0].clientX;
          yDown = evt.touches[0].clientY;
        },

        _handleTouchMove: function (evt) {
          if (!xDown || !yDown) {
            return;
          }
          var xUp = evt.touches[0].clientX;
          var yUp = evt.touches[0].clientY;

          var xDiff = xDown - xUp;
          var yDiff = yDown - yUp;

          if (Math.abs(xDiff) > Math.abs(yDiff)) { /*most significant*/
            if (xDiff > 0) {
              this.next();
            } else {
              this.back();
            }
          }
          xDown = null;
          yDown = null;
        }

      });
    })();
  </script>
</dom-module>